(function(){var a,b,c,d,e,f,g,h,i=function(a,b){return function(){return a.apply(b,arguments)}},j=[].indexOf||function(a){for(var b=0,c=this.length;c>b;b++)if(b in this&&this[b]===a)return b;return-1};ko.mapper.handlers.callback={fromJS:function(a,b,c){var d;return d=null==c?b.$create(a):b.$update(a,c)},toJS:function(a){return a.toJS()}},ko.mapper.handlers.observe=ko.mapper.handlers.value,h=function(){var a,b,c;return b=humanFormat.makePrefixes("y,z,a,f,p,n,Âµ,m,,k,M,G,T,P,E,Z,Y".split(","),1e3,-8),c=humanFormat.makePrefixes(",k".split(","),1e3,0),a=humanFormat.makePrefixes("m,c,d,".split(","),10,-3),humanFormat.unitPrefixes={B:b,W:c,Wh:c,m:a}}(),b=function(){function a(a,b){this.device=b,this.tooltipFormatter=i(this.tooltipFormatter,this),this.tooltipHtml=i(this.tooltipHtml,this),null==a.value&&(a.value=null),this.history=ko.observableArray([]),this.lastUpdate=ko.observable(0),ko.mapper.fromJS(a,this.constructor.mapping,this),this.unitText=null!=this.unit?this.unit:"","number"===this.type&&(this.sparklineHistory=ko.pureComputed(function(a){return function(){var b,c,d,e,f,g,h;for(f=a.history(),h=[],d=0,e=f.length;e>d;d++)g=f[d],b=g.t,c=g.v,h.push([b,c]);return h}}(this)))}return a.mapping={$default:"ignore",description:"copy",label:"copy",acronym:"copy",labels:"copy",name:"copy",type:"copy",value:"observe",unit:"copy",history:"observe",lastUpdate:"observe",displaySparkline:"observe",displayUnit:"copy",discrete:"copy"},a.prototype.shouldDisplaySparkline=function(){return"number"===this.type&&this.history().length>1&&(null!=this.displaySparkline&&null!=this.displaySparkline()?this.displaySparkline():!0)},a.prototype.tooltipHtml=function(){var a;return this.label+": "+this.formatValue(this.value())+" "+this.lastUpdateTimeText()+("number"===(a=this.type)||"boolean"===a?'<a href="#" id="to-graph-page"\n  data-attributeName="'+this.name+'"\n  data-deviceId="'+this.device.id+'">Graph</a>':"")},a.prototype.outOfDate=function(){var a,b;return"number"!==this.type?!1:(b=(new Date).getTime(),a=this.lastUpdate(),b-a>18e5)},a.prototype.lastUpdateTimeText=function(){return" @ "+this.formatTime(this.lastUpdate())},a.prototype.tooltipFormatter=function(a,b,c){var d,e;return e=this.formatValue(c.y),d=this.formatTime(c.x),"<span>"+e+" @ "+d+"</span>"},a.prototype.update=function(a){return ko.mapper.fromJS(a,this.constructor.mapping,this)},a.prototype.updateValue=function(a,b){return this.value(b),this.lastUpdate(a),30===this.history().length&&this.history.shift(),this.history.push({t:a,v:b})},a.prototype.displayValueText=function(){var a,b;return b=this.value(),null==b?__("unknown"):"number"===this.type?(a=this._getNumberFormat(b),a.num):this.formatValue(b)},a.prototype.displayUnitText=function(){var a,b;return"number"===this.type?(b=this.value(),a=this._getNumberFormat(b),a.unit):""},a.prototype.displayAcronym=function(){return this.acronym||""},a.prototype.formatValue=function(a){var b;switch(this.type){case"boolean":return this.labels?__(a===!0?this.labels[0]:this.labels[1]):a.toString();case"string":return a;case"number":return b=this._getNumberFormat(a),""+b.num+" "+b.unit;default:return a.toString()}},a.prototype._getNumberFormat=function(a){var b,c,d,e,f,g;if(e=this.unit,j.call(Object.keys(humanFormat.unitPrefixes),e)>=0)return d=null!=this.displayUnit&&null!=this.unit?this.displayUnit.substring(0,this.displayUnit.length-this.unit.length):null,b=humanFormat.humanFormatInfo(a,{unit:this.unit,prefixes:humanFormat.unitPrefixes[this.unit],prefix:d}),"W"!==(f=b.unit)&&"Wh"!==f||"k"!==b.prefix?"m"===b.unit&&""===b.prefix&&a>=1e3&&(b.num=Math.round(a/100)/10,b.prefix="k"):(b.num=Math.round(a)/1e3,b.num=b.num.toFixed(3)),{num:b.num,unit:b.prefix+b.unit};if("kW"===(g=this.unit)||"kWh"===g)c=Math.round(1e3*a)/1e3,c=c.toFixed(3);else{if("s"===this.unit)return c=pimatic.toHHMMSS(a),{num:c,unit:""};c=Math.round(100*a)/100}return{num:c,unit:this.unit||""}},a.prototype.formatTime=function(a){var b,c;return b=pimatic.timestampToDateTime(a),c=pimatic.timestampToDateTime(new Date),b.date!==c.date?""+b.date+" "+b.time:b.time},a.prototype.toJS=function(){return ko.mapper.toJS(this,this.constructor.mapping)},a}(),a=function(){function a(b){var c,d,e,f;for(a.mapping.device=this,ko.mapper.fromJS(b,this.constructor.mapping,this),this.configObserve=ko.observable(b.config),this.rest={},f=this.actions,d=0,e=f.length;e>d;d++)c=f[d],pimatic.client.createRestAction(this.rest,c.name,c,{type:"get",url:"/api/device/"+this.id+"/"+c.name});this.group=ko.pureComputed(function(a){return function(){return"null"===a.id?null:pimatic.getGroupOfDevice(a.id)}}(this)),this.configWithDefaults=ko.pureComputed(function(a){return function(){var b,c,d,e,f;d={},e=a.configDefaults;for(c in e)b=e[c],d[c]=b;f=a.configObserve();for(c in f)b=f[c],d[c]=b;return d}}(this))}return a.mapping={$default:"ignore",name:"observe",config:"copy",configDefaults:"copy",id:"copy",template:"copy",actions:"copy",attributes:{$key:"name",$itemOptions:{$handler:"callback",$create:function(c){return new b(c,a.mapping.device)},$update:function(a,b){return b.update(a),b}}}},a.prototype.update=function(b){return a.mapping.device=this,ko.mapper.fromJS(b,this.constructor.mapping,this),this.configObserve(b.config)},a.prototype.toJS=function(){return ko.mapper.toJS(this,this.constructor.mapping)},a.prototype.getAttribute=function(a){return ko.utils.arrayFirst(this.attributes(),function(){return function(b){return b.name===a}}(this))},a.prototype.updateAttribute=function(a,b,c){var d;return d=this.getAttribute(a),null!=d?d.updateValue(b,c):void 0},a.prototype.hasAttibuteWith=function(a){var b,c,d,e;for(e=this.attributes(),c=0,d=e.length;d>c;c++)if(b=e[c],a(b))return!0;return!1},a}(),f=function(){function a(a){ko.mapper.fromJS(a,this.constructor.mapping,this),this.group=ko.pureComputed(function(a){return function(){return pimatic.getGroupOfRule(a.id)}}(this))}return a.mapping={$default:"ignore",id:"copy",name:"observe",string:"observe",actionsToken:"observe",conditionToken:"observe",error:"observe",active:"observe",logging:"observe",valid:"observe"},a.prototype.update=function(a){return ko.mapper.fromJS(a,this.constructor.mapping,this)},a.prototype.toJS=function(){return ko.mapper.toJS(this,this.constructor.mapping)},a}(),g=function(){function a(a){null==a.value&&(a.value=null),null==a.exprInputStr&&(a.exprInputStr=null),null==a.exprTokens&&(a.exprTokens=null),ko.mapper.fromJS(a,this.constructor.mapping,this),this.displayName=ko.pureComputed(function(a){return function(){return"$"+a.name}}(this)),this.hasValue=ko.pureComputed(function(a){return function(){return null!=a.value()}}(this)),this.displayValue=ko.pureComputed(function(a){return function(){return a.hasValue()?a.value():"null"}}(this)),this.group=ko.pureComputed(function(a){return function(){return pimatic.getGroupOfVariable(a.name)}}(this))}return a.mapping={$default:"ignore",exprInputStr:"observe",exprTokens:"observe",name:"copy",readonly:"observe",type:"observe",value:"observe",unit:"observe"},a.prototype.isDeviceAttribute=function(){return-1!==$.inArray(".",this.name)},a.prototype.update=function(a){return ko.mapper.fromJS(a,this.constructor.mapping,this)},a.prototype.toJS=function(){return ko.mapper.toJS(this,this.constructor.mapping)},a}(),c=function(){function a(a){ko.mapper.fromJS(a,this.constructor.mapping,this),this.deviceByGroups=ko.pureComputed(function(a){return function(){var b,c,d,e,f,g,h;for(e={$ungrouped:[]},h=a.devices(),f=0,g=h.length;g>f;f++)b=h[f],b.device!==pimatic.nullDevice&&(c=pimatic.getGroupOfDevice(b.device.id),d=(null!=c?c.id:void 0)||"$ungrouped",null!=e[d]?e[d].push(b):e[d]=[b]);return e}}(this))}return a.mapping={$default:"ignore",id:"copy",name:"observe",devices:{$key:"deviceId",$itemOptions:{$handler:"callback",$create:function(a){var b,c;return b=pimatic.getDeviceById(a.deviceId),null==b&&(b=pimatic.nullDevice),c=pimatic.templateClasses[b.template],null==c&&(console.warn("Could not find a template class for "+a.template),c=pimatic.DeviceItem),null==b?console.error("Device should never be null"):new c(a,b)},$update:function(a,b){return b.update(a),b}}}},a.prototype.getDevicesInGroup=function(a){return this.deviceByGroups()[a]||[]},a.prototype.getUngroupedDevices=function(){return this.deviceByGroups().$ungrouped},a.prototype.update=function(a){return ko.mapper.fromJS(a,this.constructor.mapping,this)},a.prototype.getDeviceTemplate=function(a){return a.getDeviceTemplate()},a.prototype.afterRenderDevice=function(a,b){return b.afterRender(a)},a.prototype.toJS=function(){return ko.mapper.toJS(this,this.constructor.mapping)},a}(),d=function(){function a(a){ko.mapper.fromJS(a,this.constructor.mapping,this),this.getDevices=ko.pureComputed(function(a){return function(){var b,c,d,e,f,g;for(d=[],g=a.devices(),e=0,f=g.length;f>e;e++)b=g[e],c=pimatic.getDeviceById(b),null!=c&&d.push(c);return d}}(this)),this.getRules=ko.pureComputed(function(a){return function(){var b,c,d,e,f,g;for(d=[],g=a.rules(),e=0,f=g.length;f>e;e++)b=g[e],c=pimatic.getRuleById(b),null!=c&&d.push(c);return d}}(this)),this.getVariables=ko.pureComputed(function(a){return function(){var b,c,d,e,f,g;for(d=[],g=a.variables(),e=0,f=g.length;f>e;e++)b=g[e],c=pimatic.getVariableByName(b),null!=c&&d.push(c);return d}}(this))}return a.mapping={$default:"ignore",id:"copy",name:"observe",rules:"array",devices:"array",variables:"array"},a.prototype.update=function(a){return ko.mapper.fromJS(a,this.constructor.mapping,this)},a.prototype.getDevicesWithAttibute=function(a){var b;return function(){var c,d,e,f;for(e=this.getDevices(),f=[],c=0,d=e.length;d>c;c++)b=e[c],b.hasAttibuteWith(a)&&f.push(b);return f}.call(this)},a.prototype.getDevicesWithGraphableAttribute=function(){return this.getDevicesWithAttibute(function(){return function(a){var b;return"number"===(b=a.type)||"boolean"===b}}(this))},a.prototype.containsDevice=function(a){var b;return b=ko.utils.arrayIndexOf(this.devices(),a),-1!==b},a.prototype.toJS=function(){return ko.mapper.toJS(this,this.constructor.mapping)},a}(),e=function(){function b(){this.isDemo=i(this.isDemo,this),this.hasPermission=i(this.hasPermission,this),window.pimatic=this,this.client=new DeclApiClient(api),this.updateFromJs({devices:[],rules:[],variables:[],devicepages:[],groups:[],errorCount:0,rememberme:!1,updateProcessStatus:"idle",updateProcessMessages:[],guiSettings:null,username:null,role:null,permissions:[{pages:"none",rules:"none",variables:"none",messages:"none",events:"none",devices:"none",groups:"none",plugins:"none",updates:"none"}]}),this.setupStorage(),this.updateProcessStatus.subscribe(function(){return function(a){switch(a){case"running":return pimatic.loading("update-process-status","show",{text:__("Installing updates, Please be patient")});default:return pimatic.loading("update-process-status","hide")}}}(this)),this.autosave=ko.computed(function(a){return function(){var b;if(a._dataLoaded())return b=a.toJS(),pimatic.storage.set("pimatic.scope",b)}}(this)).extend({rateLimit:{timeout:500,method:"notifyWhenChangesStop"}}),this.rememberme.subscribe(function(){return function(a){var b;return b=pimatic.storage.get("pimatic"),pimatic.storage.removeAll(),pimatic.storage=a?$.localStorage:$.sessionStorage,b.scope.rememberMe=a,pimatic.storage.set("pimatic",b)}}(this)),this.getUngroupedDevices=ko.pureComputed(function(a){return function(){var b,c,d,e,f;for(e=a.devices(),f=[],c=0,d=e.length;d>c;c++)b=e[c],null==b.group()&&f.push(b);return f}}(this))}return b.mapping={$default:"ignore",devices:{$key:"id",$itemOptions:{$handler:"callback",$create:function(b){return new a(b)},$update:function(a,b){return b.update(a),b}}},rules:{$key:"id",$itemOptions:{$handler:"callback",$create:function(a){return new f(a)},$update:function(a,b){return b.update(a),b}}},variables:{$key:"name",$itemOptions:{$handler:"callback",$create:function(a){return new g(a)},$update:function(a,b){return b.update(a),b}}},devicepages:{$key:"id",$itemOptions:{$handler:"callback",$create:function(a){return new c(a)},$update:function(a,b){return b.update(a),b}}},groups:{$key:"id",$itemOptions:{$handler:"callback",$create:function(a){return new d(a)},$update:function(a,b){return b.update(a),b}}},errorCount:"observe",rememberme:"observe",updateProcessStatus:"observe",updateProcessMessages:"array",guiSettings:"observe",username:"observe",role:"observe",permissions:"observe"},b.prototype.socket=null,b.prototype.inited=!1,b.prototype.pages={},b.prototype.storage=null,b.prototype._dataLoaded=ko.observable(!1),b.prototype.nullDevice=new a({id:"null",name:"null",attributes:[],actions:[],template:"null"}),b.prototype.loadDataFromStorage=function(){var a,b;if(this._dataLoaded(!0),pimatic.storage.isSet("pimatic.scope")){a=pimatic.storage.get("pimatic.scope");try{return this.updateFromJs(a)}catch(c){return b=c,TraceKit.report(b),pimatic.storage.removeAll(),window.location.reload()}}},b.prototype.updateFromJs=function(a){return ko.mapper.fromJS(a,b.mapping,this)},b.prototype.toJS=function(){return ko.mapper.toJS(this,b.mapping)},b.prototype.setupStorage=function(){return $.localStorage.isSet("pimatic")?(pimatic.storage=$.localStorage,$.sessionStorage.removeAll(),this.rememberme(!0)):$.sessionStorage.isSet("pimatic")?(pimatic.storage=$.sessionStorage,$.localStorage.removeAll(),this.rememberme(!1)):(pimatic.storage=$.sessionStorage,this.rememberme(!1),pimatic.storage.set("pimatic",{}))},b.prototype.getDeviceById=function(a){return ko.utils.arrayFirst(this.devices(),function(){return function(b){return b.id===a}}(this))},b.prototype.getGroupOfDevice=function(a){var b,c,d,e,f;for(f=this.groups(),d=0,e=f.length;e>d;d++)if(b=f[d],c=ko.utils.arrayIndexOf(b.devices(),a),-1!==c)return b;return null},b.prototype.updateDeviceAttribute=function(a,b,c,d){var e,f,g,h,i;for(h=this.devices(),i=[],f=0,g=h.length;g>f;f++){if(e=h[f],e.id===a){e.updateAttribute(b,c,d);break}i.push(void 0)}return i},b.prototype.updateDeviceFromJs=function(a){var c;return c=this.getDeviceById(a.id),null==c?(c=b.mapping.devices.$itemOptions.$create(a),this.devices.push(c)):c.update(a)},b.prototype.updateDeviceOrder=function(a){var b;return b=function(b){var c;return c=$.inArray(b,a),-1===c?999999:c},this.devices.sort(function(){return function(a,c){return b(a.id)-b(c.id)}}(this))},b.prototype.removeDevice=function(a){return this.devices.remove(function(){return function(b){return b.id===a}}(this))},b.prototype.getPageById=function(a){return ko.utils.arrayFirst(this.devicepages(),function(){return function(b){return b.id===a}}(this))},b.prototype.removePage=function(a){return this.devicepages.remove(function(){return function(b){return b.id===a}}(this))},b.prototype.updatePageFromJs=function(a){var c;return c=this.getPageById(a.id),null==c?(c=b.mapping.devicepages.$itemOptions.$create(a),this.devicepages.push(c)):c.update(a)},b.prototype.updatePageOrder=function(a){var b;return b=function(b){var c;return c=$.inArray(b,a),-1===c?999999:c},this.devicepages.sort(function(){return function(a,c){return b(a.id)-b(c.id)}}(this))},b.prototype.getGroupById=function(a){return ko.utils.arrayFirst(this.groups(),function(){return function(b){return b.id===a}}(this))},b.prototype.removeGroup=function(a){return this.groups.remove(function(){return function(b){return b.id===a}}(this))},b.prototype.updateGroupFromJs=function(a){var c;return c=this.getGroupById(a.id),null==c?(c=b.mapping.groups.$itemOptions.$create(a),this.groups.push(c)):c.update(a)},b.prototype.getGroupOfRule=function(a){var b,c,d,e,f;for(f=this.groups(),d=0,e=f.length;e>d;d++)if(b=f[d],c=ko.utils.arrayIndexOf(b.rules(),a),-1!==c)return b;return null},b.prototype.updateGroupOrder=function(a){var b;return b=function(b){var c;return c=$.inArray(b,a),-1===c?999999:c},this.groups.sort(function(){return function(a,c){return b(a.id)-b(c.id)}}(this))},b.prototype.getRuleById=function(a){return ko.utils.arrayFirst(this.rules(),function(){return function(b){return b.id===a}}(this))},b.prototype.removeRule=function(a){return this.rules.remove(function(){return function(b){return b.id===a}}(this))},b.prototype.updateRuleFromJs=function(a){var c;return c=this.getRuleById(a.id),null==c?(c=b.mapping.rules.$itemOptions.$create(a),this.rules.push(c)):c.update(a)},b.prototype.updateRuleOrder=function(a){var b;return b=function(b){var c;return c=$.inArray(b,a),-1===c?999999:c},this.rules.sort(function(){return function(a,c){return b(a.id)-b(c.id)}}(this))},b.prototype.removeVariable=function(a){return this.variables.remove(function(){return function(b){return b.name===a}}(this))},b.prototype.getVariableByName=function(a){return ko.utils.arrayFirst(this.variables(),function(){return function(b){return b.name===a}}(this))},b.prototype.updateVariableValue=function(a,b){var c;return c=this.getVariableByName(a),null!=c?c.value(b):void 0},b.prototype.updateVariableFromJs=function(a){var c;return c=this.getVariableByName(a.name),null==c?(c=b.mapping.variables.$itemOptions.$create(a),this.variables.push(c)):c.update(a)},b.prototype.updateVariableOrder=function(a){var b;return b=function(b){var c;return c=$.inArray(b,a),-1===c?999999:c},this.variables.sort(function(){return function(a,c){return b(a.name)-b(c.name)}}(this))},b.prototype.getGroupOfVariable=function(a){var b,c,d,e,f;for(f=this.groups(),d=0,e=f.length;e>d;d++)if(b=f[d],c=ko.utils.arrayIndexOf(b.variables(),a),-1!==c)return b;return null},b.prototype.hasPermission=function(a,b){var c;switch(c=this.permissions()[a],b){case"read":return"read"===c||"write"===c;case"write":return"write"===c;default:return!1}},b.prototype.isDemo=function(){var a;return null!=(a=this.guiSettings())?a.demo:void 0},b}(),window.pimatic=new e,window.pimatic.Device=a,window.pimatic.Rule=f,window.pimatic.Group=d,window.pimatic.Variable=g,window.pimatic.DevicePage=c,$(document).on("templateready",function(){pimatic._dataLoaded()||pimatic.loadDataFromStorage()})}).call(this);