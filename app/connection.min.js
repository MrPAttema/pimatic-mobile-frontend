(function(){var a;a=pimatic.tryCatch,$(document).on("pagebeforecreate",function(b){var c;if(null==pimatic.socket)return pimatic.socket=io(""+document.location.host+"/",{reconnection:!0,reconnectionDelay:1e3,reconnectionDelayMax:3e3,timeout:2e4,forceNew:!0}),pimatic.socket.io.on("open",function(){var a;if(pimatic.loading("socket","hide"),null!=window.applicationCache)try{return window.applicationCache.update()}catch(b){return a=b,console.log(a)}}),c=0,pimatic.socket.on("connect",function(){var a;return pimatic.loading("socket","hide"),null!=(a=pimatic.pages.login)&&a.hideLoginDialog(),c=0,pimatic.socket.emit("call",{id:"errorMessageCount",action:"queryMessagesCount",params:{criteria:{level:"error"}}}),pimatic.socket.emit("call",{id:"guiSettings",action:"getGuiSettings",params:{}}),pimatic.socket.emit("call",{id:"updateProcessStatus",action:"getUpdateProcessStatus",params:{}})}),pimatic.socket.on("callResult",function(a){var b,c,d,e,f;switch(a.id){case"errorMessageCount":if(a.success)return pimatic.errorCount(a.result.count);break;case"guiSettings":if(a.success){b=a.result.guiSettings,f=b.defaults;for(d in f)e=f[d],null==b.config[d]&&(b.config[d]=e);return pimatic.guiSettings(b.config)}break;case"updateProcessStatus":return c=a.result.info,pimatic.updateProcessStatus(c.status),pimatic.updateProcessMessages(c.messages)}}),pimatic.socket.on("hello",a(function(a){return pimatic.username(a.username),pimatic.role(a.role),pimatic.permissions(a.permissions)})),pimatic.socket.on("devices",a(function(a){return pimatic.updateFromJs({devices:a})})),pimatic.socket.on("rules",a(function(a){return pimatic.updateFromJs({rules:a})})),pimatic.socket.on("variables",a(function(a){return pimatic.updateFromJs({variables:a})})),pimatic.socket.on("pages",a(function(a){return pimatic.updateFromJs({devicepages:a})})),pimatic.socket.on("groups",a(function(a){return pimatic.updateFromJs({groups:a})})),pimatic.socket.on("deviceAttributeChanged",function(a){return pimatic.updateDeviceAttribute(a.deviceId,a.attributeName,a.time,a.value)}),pimatic.socket.on("deviceOrderChanged",a(function(a){return pimatic.updateDeviceOrder(a)})),pimatic.socket.on("deviceChanged",a(function(a){return pimatic.updateDeviceFromJs(a)})),pimatic.socket.on("deviceRemoved",a(function(a){return pimatic.removeDevice(a.id)})),pimatic.socket.on("deviceAdded",a(function(a){return pimatic.updateDeviceFromJs(a)})),pimatic.socket.on("pageChanged",a(function(a){return pimatic.updatePageFromJs(a)})),pimatic.socket.on("pageRemoved",a(function(a){return pimatic.removePage(a.id)})),pimatic.socket.on("pageAdded",a(function(a){return pimatic.updatePageFromJs(a)})),pimatic.socket.on("pageOrderChanged",a(function(a){return pimatic.updatePageOrder(a)})),pimatic.socket.on("groupChanged",a(function(a){return pimatic.updateGroupFromJs(a)})),pimatic.socket.on("groupRemoved",a(function(a){return pimatic.removeGroup(a.id)})),pimatic.socket.on("groupAdded",a(function(a){return pimatic.updateGroupFromJs(a)})),pimatic.socket.on("groupOrderChanged",a(function(a){return pimatic.updateGroupOrder(a)})),pimatic.socket.on("ruleAdded",a(function(a){return pimatic.updateRuleFromJs(a)})),pimatic.socket.on("ruleChanged",a(function(a){return pimatic.updateRuleFromJs(a)})),pimatic.socket.on("ruleRemoved",a(function(a){return pimatic.removeRule(a.id)})),pimatic.socket.on("ruleOrderChanged",a(function(a){return pimatic.updateRuleOrder(a)})),pimatic.socket.on("variableAdded",a(function(a){return pimatic.updateVariableFromJs(a)})),pimatic.socket.on("variableChanged",a(function(a){return pimatic.updateVariableFromJs(a)})),pimatic.socket.on("variableValueChanged",a(function(a){return pimatic.updateVariableValue(a.variableName,a.variableValue)})),pimatic.socket.on("variableRemoved",a(function(a){return pimatic.removeVariable(a.name)})),pimatic.socket.on("variableOrderChanged",a(function(a){return pimatic.updateVariableOrder(a)})),pimatic.socket.on("updateProcessStatus",a(function(a){return pimatic.updateProcessStatus(a.status)})),pimatic.socket.on("updateProcessMessage",a(function(a){return pimatic.updateProcessMessages.push(a.message)})),pimatic.socket.on("messageLogged",a(function(a){return"debug"!==a.level&&pimatic["try"](function(b){return function(){return pimatic.showToast(a.msg)}}(this)),"error"===a.level?pimatic.errorCount(pimatic.errorCount()+1):void 0})),pimatic.loading("socket","show",{text:__("Connecting"),blocking:!1}),pimatic.socket.io.on("reconnect_attempt",function(){return pimatic.loading("socket","show",{text:__("Reconnecting"),blocking:!1})}),pimatic.socket.io.on("connect_error",function(a){return pimatic.loading("socket","show",{text:__("Could not connect (%s), retrying",a.message),blocking:!1})}),pimatic.socket.io.on("connect_timeout",function(){return pimatic.loading("socket","show",{text:__("Connect timed out"),blocking:!1})}),pimatic.socket.io.on("close",function(){return pimatic.socket.io.reconnection()===!0?pimatic.socket.io.reconnect():void 0}),pimatic.socket.on("error",function(a){var b;return c++,pimatic.socket.io.disconnect(),"Authentication error"===a&&null!=(null!=(b=pimatic.pages)?b.login:void 0)?(pimatic.socket.io.reconnection(!1),pimatic.pages.login.showLoginDialog()):pimatic.loading("socket","show",{text:__("Connection lost: %s",a),blocking:!1})}),function(){var a,b,c,d;return b=null,d=null,c=null,a=function(){document[b]?(clearTimeout(c),c=setTimeout(function(){return pimatic.socket.io.reconnection(!1),pimatic.socket.io.disconnect()},1e4)):(clearTimeout(c),pimatic.socket.io.reconnection(!0),pimatic.socket.connected||(pimatic.loading("socket","show",{text:__("Reconnecting"),blocking:!1}),pimatic.socket.io.connect()))},null!=document.hidden?(b="hidden",d="visibilitychange"):null!=document.mozHidden?(b="mozHidden",d="mozvisibilitychange"):null!=document.msHidden?(b="msHidden",d="msvisibilitychange"):null!=document.webkitHidden&&(b="webkitHidden",d="webkitvisibilitychange"),null!=document.addEventListener&&null!=document[b]?document.addEventListener(d,a,!1):void 0}()})}).call(this);