(function(){var a,b=[].indexOf||function(a){for(var b=0,c=this.length;c>b;b++)if(b in this&&this[b]===a)return b;return-1};a=pimatic.tryCatch,$(document).on("pagecreate","#log-page",a(function(c){var d,e,f;d=function(){function c(){this.hasPermission=pimatic.hasPermission,this.updateFromJs([]),this.displayedMessages=ko.computed(function(a){return function(){var c,d,e,f,g;return c=a.chosenLevels(),d=a.chosenTag(),g=a.messages(),e=function(){var a,e,h,i;for(i=[],a=0,e=g.length;e>a;a++)f=g[a],h=f.level,b.call(c,h)>=0&&("All"===d||b.call(f.tags,d)>=0)&&i.push(f);return i}()}}(this)).extend({rateLimit:{timeout:10,method:"notifyAtFixedRate"}}),ko.computed(function(a){return function(){return a.chosenLevels(),a.chosenTag(),a.loadMessages()}}(this)),this.messageCountText=ko.computed(function(a){return function(){var b;return b=a.messageCount(),null!=b?__("Showing %s of %s Messages",a.displayedMessages().length,b):""}}(this)),this.updateListView=ko.computed(function(a){return function(){return a.displayedMessages(),$("#log-messages").listview("refresh")}}(this)),pimatic.socket.on("messageLogged",a(function(a){return function(b){return a.messages.unshift({tags:b.meta.tags,level:b.level,text:b.msg,time:b.meta.timestamp})}}(this)))}return c.mapping={$default:"ignore",messages:{$key:"id",$itemOptions:{$handler:"copy"}}},c.prototype.chosenLevels=ko.observableArray(["info","warn","error"]),c.prototype.tags=ko.observableArray(["All","pimatic"]),c.prototype.chosenTag=ko.observableArray([]),c.prototype.messageCount=ko.observable(null),c.prototype.updateFromJs=function(a){return ko.mapper.fromJS({messages:a},c.mapping,this)},c.prototype.timeToShow=function(a){var b,c,d,e,f,g,h,i,j;return a=a(),d=this.displayedMessages(),0===a?(f=d[a],null==f?"":(e=pimatic.timestampToDateTime(null!=f?f.time:void 0),""+e.date+" "+e.time)):(i=[d[a-1],d[a]],g=i[0],h=i[1],j=[pimatic.timestampToDateTime(g.time),pimatic.timestampToDateTime(h.time)],b=j[0],c=j[1],c.date===b.date?c.time:""+c.date+" "+c.time)},c.prototype.orderedInsert=function(a,b){var c,d,e,f,g,h;for(this.list=a,e=-1,h=this.list,d=f=0,g=h.length;g>f;d=++f)if(c=h[d],c>=b){e=d;break}return-1===e?this.list.push(b):this.list.splice(d,0,b)},c.prototype.loadMessages=function(){var c;return c=function(c){return function(){var d;if(null==c.loadMessagesAjax)return pimatic.loading("loading message","show",{text:__("Loading Messages")}),d={level:c.chosenLevels(),limit:100},"All"!==c.chosenTag()&&(d.tags=c.chosenTag()),pimatic.client.rest.queryMessages({criteria:d},{timeout:6e4,global:!1}).always(function(){return pimatic.loading("loading message","hide")}).done(a(function(a){var d,e,f,g,h,i,j,k;if(c.loadMessagesAjax=null,a.success)for(c.updateFromJs(a.messages),j=a.messages,f=0,h=j.length;h>f;f++)for(d=j[f],k=d.tags,g=0,i=k.length;i>g;g++)e=k[g],b.call(c.tags(),e)<0&&c.orderedInsert(c.tags,e)})).fail(ajaxAlertFail)}}(this),null==this.loadMessagesAjax?c():this.loadMessagesAjax.done(function(a){return function(){return c()}}(this))},c.prototype.loadMessagesMeta=function(){return pimatic.client.rest.queryMessagesTags({criteria:{}}).done(a(function(a){return function(c){var d,e,f,g,h;if(c.success){for(g=c.tags,h=[],e=0,f=g.length;f>e;e++)d=g[e],b.call(a.tags(),d)<0?h.push(a.orderedInsert(a.tags,d)):h.push(void 0);return h}}}(this))),pimatic.client.rest.queryMessagesCount({criteria:{}}).done(a(function(a){return function(b){return b.success?a.messageCount(b.count):void 0}}(this)))},c}();try{pimatic.pages.log=f=new d,pimatic.socket.on("log",a(function(a){var b;return b=f.messageCount(),null!=b&&f.messageCount(b+1),f.messages.unshift(a)})),$("#log-page").on("click","#clear-log",a(function(b,c){var d;return d=f.messages[f.messages.length-1],pimatic.client.rest.deleteMessages({criteria:{}}).done(a(function(){var a,b;return f.messages.removeAll(),null!=(a=pimatic.pages)&&null!=(b=a.index)&&b.errorCount(0),f.messageCount(0)})).fail(ajaxAlertFail)})),ko.applyBindings(f,$("#log-page")[0])}catch(g){e=g,TraceKit.report(e)}})),$(document).on("pagebeforeshow","#log-page",a(function(a){var b,c;try{return c=pimatic.pages.log,null!=jQuery.mobile.pageParams&&(jQuery.mobile.pageParams.selectErrors&&c.chosenLevels(["error"]),jQuery.mobile.pageParams=null),c.loadMessages(),c.loadMessagesMeta()}catch(d){return b=d,TraceKit.report(b)}}))}).call(this);