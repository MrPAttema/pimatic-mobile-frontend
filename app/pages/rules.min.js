(function(){var a,b=function(a,b){return function(){return a.apply(b,arguments)}};a=pimatic.tryCatch,$(document).on("pagebeforecreate","#rules-page",a(function(c){var d,e;return d=function(){function c(){this.saveCollapseState=b(this.saveCollapseState,this),this.onEditRuleClicked=b(this.onEditRuleClicked,this),this.isGroupCollapsed=b(this.isGroupCollapsed,this),this.toggleGroup=b(this.toggleGroup,this),this.onRulesSorted=b(this.onRulesSorted,this);var c;this.rules=pimatic.rules,this.groups=pimatic.groups,this.hasPermission=pimatic.hasPermission,c=pimatic.storage.get("pimatic.rules")||{},this.collapsedGroups=ko.observable(c.collapsed||{}),this.rulesListViewRefresh=ko.computed(a(function(a){return function(){var b,c,d,e;for(a.rules(),a.isSortingRules(),a.enabledEditing(),a.collapsedGroups(),e=a.groups(),c=0,d=e.length;d>c;c++)b=e[c],b.rules();return pimatic["try"](function(){return $("#rules").listview("refresh").addClass("dark-background")})}}(this))).extend({rateLimit:{timeout:1,method:"notifyWhenChangesStop"}}),this.lockButton=ko.computed(a(function(a){return function(){var b;return b=a.enabledEditing(),{icon:b?"check":"gear"}}}(this))),this.getUngroupedRules=ko.computed(a(function(a){return function(){var b,c,d,e,f,g,h,i,j,k;for(e=[],c=[],j=a.groups(),f=0,h=j.length;h>f;f++)b=j[f],c=c.concat(b.rules());for(k=a.rules(),g=0,i=k.length;i>g;g++)d=k[g],-1===ko.utils.arrayIndexOf(c,d.id)&&e.push(d);return e}}(this))),this.ruleCss=ko.computed(a(function(a){return function(){var a,b;return a="",b=pimatic.guiSettings(),null==b?a:(b.hideRuleName&&(a+=" hideRuleName"),b.hideRuleText&&(a+=" hideRuleText"),a)}}(this))),pimatic.fixedAddElement(this.enabledEditing,this.isSortingRules,$("#add-rule"),$("#rules"))}return c.prototype.enabledEditing=ko.observable(!1),c.prototype.isSortingRules=ko.observable(!1),c.prototype.afterRenderRule=function(a,b){var c;return c=$("#sortable-handle-template").text(),$(a).find("a").before($(c))},c.prototype.toggleEditing=function(){return this.enabledEditing(!this.enabledEditing())},c.prototype.onRulesSorted=function(a,b,c){var d,e,f,g,h,i,j;return d=function(b){return function(b,c){var d,e;return e=null==c?0:ko.utils.arrayIndexOf(b.rules(),c.id)+1,-1===e&&(e=0),d=b.id,pimatic.client.rest.addRuleToGroup({ruleId:a.id,groupId:d,position:e}).done(ajaxShowToast).fail(ajaxAlertFail)}}(this),g=function(b){return function(b){var c;return c=b.id,pimatic.client.rest.removeRuleFromGroup({ruleId:a.id,groupId:c}).done(ajaxShowToast).fail(ajaxAlertFail)}}(this),j=function(b){return function(c){var d,e,f,g,h;for(e=[],null==c&&e.push(a.id),h=b.rules(),f=0,g=h.length;g>f;f++)d=h[f],d!==a&&(e.push(d.id),null!=c&&d===c&&e.push(a.id));return pimatic.client.rest.updateRuleOrder({ruleOrder:e}).done(ajaxShowToast).fail(ajaxAlertFail)}}(this),i=function(b){return function(b,c){var d,e,f,g,h;for(e=[],null==c&&e.push(a.id),h=b.rules(),f=0,g=h.length;g>f;f++)d=h[f],d!==a.id&&(e.push(d),null!=c&&d===c.id&&e.push(a.id));return pimatic.client.rest.updateGroup({groupId:b.id,group:{rulesOrder:e}}).done(ajaxShowToast).fail(ajaxAlertFail)}}(this),null!=b?(e=b instanceof pimatic.Rule?b.group():b instanceof pimatic.Group?b:null,h=b instanceof pimatic.Rule?b:void 0,f=a.group(),e!==f?null!=e?d(e,h):null!=f?g(f):j(h):null!=e?i(e,h):j(h)):void 0},c.prototype.onDropRuleOnTrash=function(a){var b,c;return c=confirm(__("Do you really want to delete the %s rule?",a.name())),c?(b=function(b){return function(){return pimatic.loading("deleterule","show",{text:__("Saving")}),pimatic.client.rest.removeRule({ruleId:a.id}).always(function(){return pimatic.loading("deleterule","hide")}).done(ajaxShowToast).fail(ajaxAlertFail)}}(this))():void 0},c.prototype.toggleGroup=function(a){var b;return b=this.collapsedGroups(),b[a.id]?delete b[a.id]:b[a.id]=!0,this.collapsedGroups(b),this.saveCollapseState(),!1},c.prototype.isGroupCollapsed=function(a){return this.collapsedGroups()[a.id]===!0},c.prototype.onAddRuleClicked=function(){return jQuery.mobile.pageParams={action:"add"},!0},c.prototype.onEditRuleClicked=function(a){return this.hasPermission("rules","write")||pimatic.isDemo()?(jQuery.mobile.pageParams={action:"update",rule:a},!0):(pimatic.showToast(__("Sorry, you have no permissions to edit this rule.")),!1)},c.prototype.saveCollapseState=function(){var a;return a=pimatic.storage.get("pimatic.rules")||{},a.collapsed=this.collapsedGroups(),pimatic.storage.set("pimatic.rules",a)},c}(),pimatic.pages.rules=e=new d})),$(document).on("pagecreate","#rules-page",a(function(a){var b,c,d;c=pimatic.pages.rules;try{ko.applyBindings(c,$("#rules-page")[0])}catch(e){b=e,TraceKit.report(b),null!=(d=pimatic.storage)&&d.removeAll(),window.location.reload()}$("#rules .handle").disableSelection()})),$(document).on("pagebeforeshow","#rules-page",a(function(a){return pimatic["try"](function(a){return function(){return $("#rules").listview("refresh").addClass("dark-background")}}(this))}))}).call(this);