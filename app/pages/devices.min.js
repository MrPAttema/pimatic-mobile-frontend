(function(){var a,b=function(a,b){return function(){return a.apply(b,arguments)}};a=pimatic.tryCatch,$(document).on("pagebeforecreate","#devices-page",a(function(){var c,d;return c=function(){function c(){this.saveCollapseState=b(this.saveCollapseState,this),this.isGroupCollapsed=b(this.isGroupCollapsed,this),this.toggleGroup=b(this.toggleGroup,this),this.onEditDeviceClicked=b(this.onEditDeviceClicked,this),this.onDevicesSorted=b(this.onDevicesSorted,this);var c;this.devices=pimatic.devices,this.groups=pimatic.groups,this.hasPermission=pimatic.hasPermission,c=pimatic.storage.get("pimatic.devices")||{},this.collapsedGroups=ko.observable(c.collapsed||{}),this.devicesListViewRefresh=ko.computed(a(function(a){return function(){var b,c,d,e;for(a.collapsedGroups(),a.devices(),a.isSortingDevices(),a.enabledEditing(),e=a.groups(),c=0,d=e.length;d>c;c++)b=e[c],b.devices();return pimatic["try"](function(){return $("#devices").listview("refresh")})}}(this))).extend({rateLimit:{timeout:1,method:"notifyWhenChangesStop"}}),this.lockButton=ko.computed(a(function(a){return function(){var b;return b=a.enabledEditing(),{icon:b?"check":"gear"}}}(this))),this.getUngroupedDevices=ko.computed(a(function(a){return function(){var b,c,d,e,f,g,h,i,j,k;for(e=[],d=[],j=a.groups(),f=0,h=j.length;h>f;f++)c=j[f],d=d.concat(c.devices());for(k=a.devices(),g=0,i=k.length;i>g;g++)b=k[g],-1===ko.utils.arrayIndexOf(d,b.id)&&e.push(b);return e}}(this)))}return c.prototype.enabledEditing=ko.observable(!1),c.prototype.isSortingDevices=ko.observable(!1),c.prototype.afterRenderDevice=function(a){var b;return b=$("#sortable-handle-template").text(),$(a).find("a").before($(b))},c.prototype.toggleEditing=function(){return this.enabledEditing(!this.enabledEditing())},c.prototype.onDevicesSorted=function(a,b){var c,d,e,f,g,h,i;return c=function(){return function(b,c){var d,e;return e=null==c?0:ko.utils.arrayIndexOf(b.devices(),c.id)+1,-1===e&&(e=0),d=b.id,pimatic.client.rest.addDeviceToGroup({deviceId:a.id,groupId:d,position:e}).done(ajaxShowToast).fail(ajaxAlertFail)}}(this),g=function(){return function(b){var c;return c=b.id,pimatic.client.rest.removeDeviceFromGroup({deviceId:a.id,groupId:c}).done(ajaxShowToast).fail(ajaxAlertFail)}}(this),h=function(b){return function(c){var d,e,f,g,h;for(d=[],null==c&&d.push(a.id),h=b.devices(),f=0,g=h.length;g>f;f++)e=h[f],e!==a&&(d.push(e.id),null!=c&&e===c&&d.push(a.id));return pimatic.client.rest.updateDeviceOrder({deviceOrder:d}).done(ajaxShowToast).fail(ajaxAlertFail)}}(this),i=function(){return function(b,c){var d,e,f,g,h;for(e=[],null==c&&e.push(a.id),h=b.devices(),f=0,g=h.length;g>f;f++)d=h[f],d!==a.id&&(e.push(d),null!=c&&d===c.id&&e.push(a.id));return pimatic.client.rest.updateGroup({groupId:b.id,group:{devicesOrder:e}}).done(ajaxShowToast).fail(ajaxAlertFail)}}(this),null!=b?(e=b instanceof pimatic.Device?b.group():b instanceof pimatic.Group?b:null,d=b instanceof pimatic.Device?b:void 0,f=a.group(),e!==f?null!=e?c(e,d):null!=f?g(f):h(d):null!=e?i(e,d):h(d)):void 0},c.prototype.onDropDeviceOnTrash=function(a){var b,c;return c=confirm(__("Do you really want to delete the %s device?",a.name())),c?(b=function(){return function(){return pimatic.loading("deletedevice","show",{text:__("Saving")}),pimatic.client.rest.removeDevice({deviceId:a.id}).always(function(){return pimatic.loading("deletedevice","hide")}).done(ajaxShowToast).fail(ajaxAlertFail)}}(this))():void 0},c.prototype.onAddDeviceClicked=function(){return pimatic.showToast("Sorry that operation is not supported yet."),!1},c.prototype.onEditDeviceClicked=function(a){return pimatic.showToast("Sorry that operation is not supported yet."),!1},c.prototype.toggleGroup=function(a){var b;return b=this.collapsedGroups(),b[a.id]?delete b[a.id]:b[a.id]=!0,this.collapsedGroups(b),this.saveCollapseState(),!1},c.prototype.isGroupCollapsed=function(a){return this.collapsedGroups()[a.id]===!0},c.prototype.saveCollapseState=function(){var a;return a=pimatic.storage.get("pimatic.devices")||{},a.collapsed=this.collapsedGroups(),pimatic.storage.set("pimatic.devices",a)},c}(),pimatic.pages.devices=d=new c})),$(document).on("pagecreate","#devices-page",a(function(){var a,b,c;a=pimatic.pages.devices;try{ko.applyBindings(a,$("#devices-page")[0])}catch(d){b=d,TraceKit.report(b),null!=(c=pimatic.storage)&&c.removeAll(),window.location.reload()}$("#devices .handle").disableSelection()})),$(document).on("pagebeforeshow","#devices-page",a(function(){return pimatic["try"](function(){return function(){return $("#devices").listview("refresh")}}(this))}))}).call(this);