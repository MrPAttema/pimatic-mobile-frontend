(function(){var a,b=[].indexOf||function(a){for(var b=0,c=this.length;c>b;b++)if(b in this&&this[b]===a)return b;return-1};a=pimatic.tryCatch,$(document).on("pagecreate","#events-page",a(function(c){var d,e,f,g;d=function(){function a(a){this.data=a,this.device=ko.computed(function(a){return function(){return pimatic.getDeviceById(a.data.deviceId)}}(this)).extend({rateLimit:{timeout:10,method:"notifyAtFixedRate"}}),this.attribute=ko.computed(function(a){return function(){return null!=a.device()?a.device().getAttribute(a.data.attributeName):null}}(this))}return a.prototype.formatedTime=function(){var a,b,c,d;return c=function(a){return function(a){return 10>a?"0"+a:""+a}}(this),a=new Date(this.data.time),b=c(a.getDate())+"."+c(a.getMonth()+1)+"."+a.getFullYear(),d=c(a.getHours())+":"+c(a.getMinutes())+":"+c(a.getSeconds()),'<span class="date">'+b+'</span> \n<span class="time">'+d+"</span>"},a.prototype.formatedValue=function(){return null!=this.attribute()?this.attribute().formatValue(this.data.value):this.data.value},a.prototype.formatedDeviceName=function(){return null!=this.device()?'<span class="device-name">'+this.device().name()+'</span> \n<span class="device-id">('+this.data.deviceId+")</span>":this.data.deviceId},a.prototype.formatedAttributeName=function(){return null!=this.attribute()?this.attribute().label:this.data.attributeName},a}(),e=function(){function c(){this.updateFromJs([]),this.displayedEvents=ko.computed(function(a){return function(){var b,c,d,e,f;return f=a.events(),c=a.chosenDevice(),b=a.chosenAttribute(),d=function(){var a,d,g;for(g=[],a=0,d=f.length;d>a;a++)e=f[a],"All"!==c&&c!==e.data.deviceId||"All"!==b&&b!==e.data.attributeName||g.push(e);return g}()}}(this)).extend({rateLimit:{timeout:10,method:"notifyAtFixedRate"}}),ko.computed(function(a){return function(){return a.chosenDevice(),a.chosenAttribute(),a.loadEvents()}}(this)),this.eventsCountText=ko.computed(function(a){return function(){var b;return b=a.eventsCount(),null!=b?__("Showing %s of %s Events",a.displayedEvents().length,b):""}}(this)),this.updateListView=ko.computed(function(a){return function(){return a.displayedEvents(),pimatic["try"](function(){return $("#events-table").table("refresh")})}}(this)).extend({rateLimit:{timeout:10,method:"notifyAtFixedRate"}}),pimatic.socket.on("deviceAttributeChanged",function(a){return function(b){return null!=a.events?(a.events.unshift(new d({time:b.time,deviceId:b.deviceId,attributeName:b.attributeName,value:b.value})),a.eventsCount(a.eventsCount()+1)):void 0}}(this))}return c.mapping={$default:"ignore",events:{$key:function(a){return""+a.time+"-"+a.deviceId+"-"+a.attributeName},$itemOptions:{$handler:"callback",$create:function(a){return new d(a)},$update:function(a,b){return b}}}},c.prototype.devices=ko.observableArray(["All"]),c.prototype.chosenDevice=ko.observable(),c.prototype.attributes=ko.observableArray(["All"]),c.prototype.chosenAttribute=ko.observable(),c.prototype.eventsCount=ko.observable(null),c.prototype.updateFromJs=function(a){return ko.mapper.fromJS({events:a},c.mapping,this)},c.prototype.loadEvents=function(){var c;return c=function(c){return function(){var d;if(null==c.loadEventsAjax)return pimatic.loading("loading events","show",{text:__("Loading Events")}),d={limit:50,order:"time",orderDirection:"DESC"},"All"!==c.chosenDevice()&&(d.deviceId=c.chosenDevice()),"All"!==c.chosenAttribute()&&(d.attributeName=c.chosenAttribute()),pimatic.client.rest.queryDeviceAttributeEvents({criteria:d},{timeout:6e4,global:!1}).always(function(){return pimatic.loading("loading events","hide")}).done(a(function(a){var d,e,f,g,h,i;if(c.loadEventsAjax=null,a.success){for(g=a.events,e=0,f=g.length;f>e;e++)d=g[e],h=d.deviceId,b.call(c.devices(),h)<0&&c.devices.push(d.deviceId),i=d.attributeName,b.call(c.attributes(),i)<0&&c.attributes.push(d.attributeName);c.updateFromJs(a.events)}})).fail(ajaxAlertFail)}}(this),null==this.loadEventsAjax?c():this.loadEventsAjax.done(function(a){return function(){return c()}}(this))},c.prototype.loadEventsMeta=function(){return pimatic.client.rest.queryDeviceAttributeEventsDevices({}).done(a(function(a){return function(c){var d,e,f,g,h,i,j;if(c.success){for(g=c.devices,j=[],e=0,f=g.length;f>e;e++)d=g[e],h=d.deviceId,b.call(a.devices(),h)<0&&a.devices.push(d.deviceId),i=d.attributeName,b.call(a.attributes(),i)<0?j.push(a.attributes.push(d.attributeName)):j.push(void 0);return j}}}(this))),pimatic.client.rest.queryDeviceAttributeEventsCount({}).done(a(function(a){return function(b){return b.success?a.eventsCount(b.count):void 0}}(this)))},c}();try{pimatic.pages.events=g=new e,ko.applyBindings(g,$("#events-page")[0])}catch(h){f=h,TraceKit.report(f)}})),$(document).on("pagebeforeshow","#events-page",a(function(a){var b;try{return pimatic.pages.events.loadEvents(),pimatic.pages.events.loadEventsMeta()}catch(c){return b=c,TraceKit.report(b)}}))}).call(this);