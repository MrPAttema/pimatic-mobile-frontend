(function(){var a,b=[].indexOf||function(a){for(var b=0,c=this.length;c>b;b++)if(b in this&&this[b]===a)return b;return-1};a=Array.prototype.concat,LazyLoad.js(a.apply(scripts.jsonschemaeditor)),$(document).on("pagebeforecreate","#edit-device-page",function(a){var b,c;if(null==pimatic.pages.editDevice){b=function(){function a(){this.pageTitle=ko.computed(function(a){return function(){return"add"===a.action()?__("Add New Device"):__("Edit Device")}}(this)),pimatic.autoFillId(this.deviceName,this.deviceId,this.action),this.deviceClass.subscribe(function(a){return function(b){return null!=b&&"string"==typeof b&&b.length>0?pimatic.client.rest.getDeviceConfigSchema({className:b}).done(function(c){var d,e,f;return null!=c.success?(d=c.configSchema||{error:__("No plugin was found that handles this device class."),type:"object",properties:{}},delete d.properties.id,delete d.properties.name,delete d.properties["class"],f=null,null==a.lastDeviceClass?(e=jsonschemaeditor.unwrap(a.deviceConfig()),f=jsonschemaeditor.wrap(d,e)):f=jsonschemaeditor.wrap(d,{}),a.configSchema(null),a.deviceConfig(f()),jsonschemaeditor.enhanceSchema(d,null),a.configSchema(d),a.lastDeviceClass=b):void 0}):a.configSchema(null)}}(this))}return a.prototype.action=ko.observable("add"),a.prototype.deviceName=ko.observable(""),a.prototype.deviceId=ko.observable(""),a.prototype.deviceClass=ko.observable(""),a.prototype.deviceClasses=ko.observableArray(),a.prototype.deviceConfig=ko.observable({}),a.prototype.configSchema=ko.observable(null),a.prototype.back=null,a.prototype.lastDeviceClass=null,a.prototype.editor=null,a.prototype.afterRenderItem=function(a,b){var c;return c=$("#sortable-handle-template").text(),$(a).find("a").before($(c))},a.prototype.resetFields=function(){return this.deviceName(""),this.deviceId(""),this.deviceConfig({}),this.deviceClass("")},a.prototype.onSubmit=function(){var a,b;return a=jsonschemaeditor.unwrap(this.deviceConfig()),b=[],jsonschemaeditor.validate(this.configSchema(),a,b),b.length>0?void alert(b.join("\n")):(a.id=this.deviceId(),a.name=this.deviceName(),a["class"]=this.deviceClass(),function(){switch(this.action()){case"add":return pimatic.client.rest.addDeviceByConfig({deviceConfig:a});case"update":return pimatic.client.rest.updateDeviceByConfig({deviceConfig:a});default:throw new Error("Illegal devicedevice action: "+action())}}.call(this).done(function(a){return function(b){var c,d;return c=null!=(d=a.back)?d:"#devices-page",b.success?$.mobile.changePage(c,{transition:"slide",reverse:!0}):alert(b.error)}}(this)).fail(ajaxAlertFail),!1)},a.prototype.onRemove=function(){var a;return a=confirm(__("Do you really want to delete the %s device?",this.deviceName())),a&&pimatic.client.rest.removeDevice({deviceId:this.deviceId()}).done(function(a){return function(b){var c,d;return c=null!=(d=a.back)?d:"#devices-page",b.success?$.mobile.changePage(c,{transition:"slide",reverse:!0}):alert(b.error)}}(this)).fail(ajaxAlertFail),!1},a.prototype.onCancel=function(){var a,b;return a=null!=(b=this.back)?b:"#devices-page",$.mobile.changePage(a,{transition:"slide",reverse:!0})},a}();try{pimatic.pages.editDevice=new b}catch(d){c=d,TraceKit.report(c)}}}),$(document).on("pagebeforeshow","#edit-device-page",function(a){var b;return b=pimatic.pages.editDevice,b.lastDeviceClass=null,pimatic.client.rest.getDeviceClasses({}).done(function(a){return function(a){var c,d;return a.success?(d=[""].concat(a.deviceClasses),c=b.deviceClass(),null!=c&&c.length>0&&d.push(c),b.deviceClasses(d)):void 0}}(this))}),$(document).on("pagecreate","#edit-device-page",function(a){var b;try{return ko.applyBindings(pimatic.pages.editDevice,$("#edit-device-page")[0])}catch(c){return b=c,TraceKit.report(b)}}),$(document).on("pagebeforeshow","#edit-device-page",function(a){var c,d,e,f,g,h;f=pimatic.pages.editDevice,h=jQuery.mobile.pageParams,jQuery.mobile.pageParams={},g=function(a){return function(a,c,d,e,g){var h,i;return f.action(a),f.deviceId(c),f.deviceName(d),f.deviceClass(null),f.configSchema(null),f.deviceConfig(e),f.back=g,h=pimatic.pages.editDevice.deviceClasses(),i=e["class"],b.call(h,i)<0&&(h.push(e["class"]),f.deviceClasses(h)),f.deviceClass(e["class"])}}(this),"update"===(null!=h?h.action:void 0)?(d=h.device,g("update",d.id,d.name(),d.config,null!=h?h.back:void 0)):"discovered"===(null!=h?h.action:void 0)?(e=h.discoveredDevice,c=e.config,g("add",c.id||"",c.name||e.deviceName,c)):(f.resetFields(),f.action("add"))})}).call(this);