(function(){var a,b,c,d=[].indexOf||function(a){for(var b=0,c=this.length;c>b;b++)if(b in this&&this[b]===a)return b;return-1};c=function(a,b){var d,e,f,g,h,i,j;if(null==a)return ko.observable(b);switch(a.type){case"string":case"number":case"integer":case"boolean":return ko.observable(b);case"object":if(null==b)return ko.observable(b);if(null!=a.properties){j=a.properties;for(f in j)g=j[f],b[f]=c(g,b[f])}return ko.observable(b);case"array":if(null==b)return ko.observableArray(b);for(e=h=0,i=b.length;i>h;e=++h)d=b[e],b[e]=c(a.items,b[e]);return ko.observableArray(b);default:return ko.observable(b)}},b=function(a){var c,d,e,f,g,h,i,j;if(a=ko.unwrap(a),null==a)return a;switch(h=a,g=Array.isArray(a)?"array":typeof a){case"object":h={};for(e in a)f=a[e],h[e]=b(f);break;case"array":for(h=[],d=i=0,j=a.length;j>i;d=++i)c=a[d],h[d]=b(c)}return h},a=function(a){return function(a){var b;if(null!=a.defaut)return a["default"];if((null!=(b=a["enum"])?b.length:void 0)>0)return a["enum"][0];switch(a.type){case"string":return"";case"number":case"integer":return 0;case"boolean":return!1;case"object":return{};case"array":return[]}}}(this),$(document).on("pagebeforecreate","#edit-device-page",function(d){var e,f;if(null==pimatic.pages.editDevice){e=function(){function d(){var d,e,f,g,h,i,j,k,l,m;this.pageTitle=ko.computed(function(a){return function(){return"add"===a.action()?__("Add New Device"):__("Edit Device")}}(this)),g=$("#device-json-editor"),pimatic.autoFillId(this.deviceName,this.deviceId,this.action),h=function(a){return function(b){var c,d,e,f,g;if(null!=a.editor){e=a.deviceConfig(),c={},d=0;for(f in e)g=e[f],"name"!==f&&"id"!==f&&"class"!==f&&(c[f]=g,d++);return 0!==d?a.editor.setValue(c):void 0}}}(this),l=function(d){var e,f,g,h,i,j,k;if(null==d.schema.properties)return[];g=ko.unwrap(d.value),null==g&&(g={},d.value(g)),j=[],k=d.schema.properties;for(f in k)h=k[f],null!=h.definedBy&&(e=ko.unwrap(g[h.definedBy]),null!=e&&e in h.options&&(h=h.options[e])),i=b(g[f]),null==i&&h.required!==!1&&null==h["default"]&&(i=a(h)),g[f]=c(h,i),j.push({schema:h,value:g[f]});return j},k=function(a){var b;return null==ko.unwrap(a)?[]:function(){var c,d,e,f;for(e=ko.unwrap(a),f=[],c=0,d=e.length;d>c;c++)b=e[c],f.push({schema:this.items||{},value:b});return f}.call(this)},m=function(a,d){return d.schema.editingItem({schema:d.schema,value:c(d.schema,b(d.value)),index:a})},f=function(a,b){var c,d;return d=b.schema.editingItem(),null!=d.index?(c=a.value(),c[d.index](d.value()),a.value(c)):a.value.push(d.value),b.schema.editingItem(null)},e=function(a){return a.schema.editingItem(null)},d=function(b){var d;d=null!=b.schema.items["default"]?c(b.schema.items,JSON.parse(JSON.stringify(b.schema.items["default"]))):c(b.schema.items,a(b.schema.items)),b.schema.items.editingItem({schema:b.schema.items,value:d})},j=function(a){var c,d;return d=b(a),"object"===this.type&&null!=this.properties&&(c="",null!=this.properties.name&&(c=d.name),null!=this.properties.id&&(c.length>0?c+=" ("+d.id+")":c=d.id),null!=c&&c.length>0)?c:JSON.stringify(d)},i=function(b,c){var g,h,n,o,p,q,r,s;switch(b.name=c,b.notDefault=function(b){return function(b){return ko.pureComputed({read:function(){return null!=("function"==typeof b.value?b.value():void 0)},write:function(c){var d;return c?(d=b.schema["default"],null==d&&(d=a(b.schema)),b.value(d)):b.value(void 0)}})}}(this),b.enabled=function(a){return function(a){return null!=("function"==typeof a.value?a.value():void 0)}}(this),b.notRequired=(null!=b?b.required:void 0)===!1,b.valueOrDefault=function(a){return function(a){return ko.pureComputed({read:function(){return null!=("function"==typeof a.value?a.value():void 0)?a.value():a.schema["default"]},write:function(b){var c;return("number"===(c=a.schema.type)||"integer"===c)&&(b=parseFloat(b)),a.value(b)}})}}(this),b.type){case"object":if(b.getProperties=l,null!=b.properties){p=b.properties;for(c in p)if(o=p[c],i(o,c),null!=(null!=(q=o.defines)?q.property:void 0)){g=b.properties[o.defines.property],g.options=o.defines.options,g.definedBy=c,r=g.options;for(h in r)n=r[h],i(n,o.defines.property)}}break;case"array":b.getItems=k,null==b.items&&(b.items={}),b.items.getItemLabel=j,b.items.onEditItemClick=m,b.items.editOk=f,b.items.editCancel=e,b.items.addItem=d,b.items.editingItem=ko.observable(null),b.items.isSorting=ko.observable(!1),b.items.onSorted=function(a){return function(a){return function(b,c,d){var e,f,g,h,i,j;for(g=0,h=0,e=a.value(),b=b.value(),c=null!=c?c.value():null,d=null!=d?d.value():null,f=i=0,j=e.length;j>=0?j>i:i>j;f=j>=0?++i:--i)e[f]()===b&&(g=f),e[f]()===d&&(h=f-1);return null==c&&(h=0),null==d&&(h=e.length-1),g!==h?(e.splice(g,1),e.splice(h,0,ko.observable(b)),a.value(e)):void 0}}}(this),b.items.onRemove=function(a){return function(a){return function(b){var c,d,e,f;for(c=a.value(),b=b.value(),d=e=0,f=c.length;f>=0?f>e:e>f;d=f>=0?++e:--e)if(c[d]()===b)return c.splice(d,1),void a.value(c)}}}(this),i(b.items,null);break;case"string":case"number":case"integer":case"boolean":null!=(null!=(s=b.defines)?s.options:void 0)&&null==b["enum"]&&(b["enum"]=Object.keys(b.defines.options))}},this.deviceClass.subscribe(function(a){return function(d){return null!=d&&"string"==typeof d&&d.length>0?pimatic.client.rest.getDeviceConfigSchema({className:d}).done(function(d){var e,f,g;return null!=d.success?(f=d.configSchema,delete f.properties.id,delete f.properties.name,delete f.properties["class"],g=b(a.deviceConfig()),e=c(f,g),a.deviceConfig(e()),i(f,null),a.configSchema(f)):void 0}):a.configSchema(null)}}(this))}return d.prototype.action=ko.observable("add"),d.prototype.deviceName=ko.observable(""),d.prototype.deviceId=ko.observable(""),d.prototype.deviceClass=ko.observable(""),d.prototype.deviceClasses=ko.observableArray(),d.prototype.deviceConfig=ko.observable({}),d.prototype.configSchema=ko.observable(null),d.prototype.editor=null,d.prototype.afterRenderItem=function(a,b){var c;return c=$("#sortable-handle-template").text(),$(a).find("a").before($(c))},d.prototype.resetFields=function(){return this.deviceName(""),this.deviceId(""),this.deviceConfig({}),this.deviceClass("")},d.prototype.onSubmit=function(){var a;return a=b(this.deviceConfig()),a.id=this.deviceId(),a.name=this.deviceName(),a["class"]=this.deviceClass(),function(){switch(this.action()){case"add":return pimatic.client.rest.addDeviceByConfig({deviceConfig:a});case"update":return pimatic.client.rest.updateDeviceByConfig({deviceConfig:a});default:throw new Error("Illegal devicedevice action: "+action())}}.call(this).done(function(a){return a.success?$.mobile.changePage("#devices-page",{transition:"slide",reverse:!0}):alert(a.error)}).fail(ajaxAlertFail),!1},d.prototype.onRemove=function(){var a;return a=confirm(__("Do you really want to delete the %s device?",this.deviceName())),a&&pimatic.client.rest.removeDevice({deviceId:this.deviceId()}).done(function(a){return a.success?$.mobile.changePage("#devices-page",{transition:"slide",reverse:!0}):alert(a.error)}).fail(ajaxAlertFail),!1},d}();try{pimatic.pages.editDevice=new e}catch(g){f=g,TraceKit.report(f)}}}),$(document).on("pagebeforeshow","#edit-device-page",function(a){return pimatic.client.rest.getDeviceClasses({}).done(function(a){return function(a){var b;return a.success?(b=[""].concat(a.deviceClasses),pimatic.pages.editDevice.deviceClasses(b)):void 0}}(this))}),$(document).on("pagecreate","#edit-device-page",function(a){var b;try{return ko.applyBindings(pimatic.pages.editDevice,$("#edit-device-page")[0])}catch(c){return b=c,TraceKit.report(b)}}),$(document).on("pagebeforeshow","#edit-device-page",function(a){var b,c,e,f,g;e=pimatic.pages.editDevice,f=jQuery.mobile.pageParams,jQuery.mobile.pageParams={},"update"===(null!=f?f.action:void 0)?(b=f.device,e.action("update"),e.deviceId(b.id),e.deviceName(b.name()),e.deviceClass(null),e.configSchema(null),e.deviceConfig(b.config),c=pimatic.pages.editDevice.deviceClasses(),g=b.config["class"],d.call(c,g)<0&&(c.push(b.config["class"]),e.deviceClasses(c)),e.deviceClass(b.config["class"])):(e.resetFields(),e.action("add"))})}).call(this);